<%- include base/header.ejs %>
<div class="main main-page">
	<div class="location clearfix">
		<h1><a href="/" title="">首页</a></h1>
	</div>
	<%if(result.posts.length > 0){%>
	<div class="chapter-col">
		<% result.posts.forEach(function(item) { %>
		<div class="chapter">
			<h2><a href="/topic/<%=item.postID%>" title="<%-item.title%>"><%-item.title%></a></h2>
			<div class="chapter-text">
				<%-item.text%>
			</div>
			<%if(item.image.length >0){%>
			<div class="chapter-img clearfix">
				<%for(var i=0;i<item.image.length;i++){%>
				<img src="<%=item.image[i]%>?imageView2/1/w/100/h/100" alt="">
				<%}%>
			</div>
			<%}%>
			<div class="chapter-info">
				<span class="text-ellipsis"><a href="#?" title="<%=item.nickname%>"><%=item.nickname%></a></span>
				<span class="postIn">发表于</span>
				<span class="text-ellipsis"><a href="/group/<%=item.groupID%>" title="<%=item.groupName%>"><%=item.groupName%></a></span>
				<span class="cha-time"><%=item.createTime%></span>
			</div>
		</div>
		<% }); %>
	</div>
	<div class="page-turn">
		<%if(result.currentPage == 1){%>
		<button type="button" class="unCBtn" id="pre">上一页</button>
		<%}else{%>
		<button type="button" id="pre">上一页</button>
		<%}%>
		<span><%=result.currentPage%>/<%=result.pageCount%></span>
		<%if(result.currentPage == result.pageCount){%>
		<button type="button" class="unCBtn" id="next">下一页</button>
		<%}else{%>
		<button type="button" id="next">下一页</button>
		<%}%>
	</div>
	<%}else{%>
	<div class="emptyPage">
		目前还没有帖子哦~~
	</div>
	<%}%>
</div>
<%- include base/baseJS.ejs %>
<script type="text/html" id="listtemplate">
	{{each posts as item i}}
	<div class="chapter">
		<h2><a href="/topic/{{item.postID}}" title="{{#item.title}}">{{#item.title}}</a></h2>
		<div class="chapter-text">{{#item.text}}</div>
		{{if item.image.length}} {{include 'imgtemplate' item}} {{/if}}
		<div class="chapter-info">
			<span class="text-ellipsis"><a href="#?" title="{{item.nickname}}">{{item.nickname}}</a></span>
			<span class="postIn">发表于</span>
			<span class="text-ellipsis"><a href="/group/{{item.groupID}}" title="{{item.groupName}}">{{item.groupName}}</a></span>
			<span class="cha-time">{{item.createTime}}</span>
		</div>
	</div>
	{{/each}}
</script>
<script type="text/html" id="imgtemplate">
	<div class="chapter-img clearfix">
		{{each image as item i}}
		<img src="{{item}}?imageView2/1/w/100/h/100" alt=""> 
		{{/each}}
	</div>
</script>
<script>
(function(){
	var index = {
		pre: $("#pre"),
		next: $("#next"),
		page: $(".page-turn").find('span').eq(0),
		main: $(".chapter-col"),
		nav_home: $(".navbar-option").find('.navbar-option-item').eq(0),
		loading: $(".loading"),
		pageCount: parseInt("<%=result.pageCount%>"),
		navActive: function() {
			this.nav_home.addClass("navbar-active");
		},
		getServerData: function(param, cb) {
			global.getData("/api/getindex",param,cb);
		},
		getPageNow:function(){
			var reg = /p=(\d+)/,
				regMatch = reg.exec(location.search),
				pageNow = regMatch === null ? 1:regMatch[1];
			return pageNow;
		},
		updateByPage:function(){
			var self = this;
			var pageNow = self.getPageNow();
			self.loading.show();
			self.getServerData({
				currentpage: pageNow
			}, function(data) {
				if (data.ret == 200 && data.data && data.data.posts.length > 0) {
					var compiled = template("listtemplate", data.data);
					self.main.html(compiled);
					self.page.text(data.data.currentPage + '/' + data.data.pageCount);
					self.pre.removeAttr('class');
					self.next.removeAttr('class');
					if (data.data.currentPage == 1) {
						self.pre.addClass('unCBtn');
					}
					if (data.data.currentPage == data.data.pageCount) {
						self.next.addClass('unCBtn')
					}
					$(window).scrollTop(0);
					self.loading.hide();
				} else {
					self.loading.hide();
					sweetAlert('错误', '数据获取失败', 'error');
				}
			});
		},
		bindEvent: function() {
			var self = this;
			self.pre.on("click", function(event) {
				event.preventDefault();
				var pageNow = self.getPageNow();
				if (pageNow == 1) {
					return;
				} else{
					pageNow--;
					var newURL = location.pathname + '?p=' + pageNow;
					history.pushState(null,'',newURL);
					self.updateByPage();
				}
			});
			self.next.on("click", function(event) {
				event.preventDefault();
				var pageNow = self.getPageNow();
				if (pageNow == self.pageCount) {
					return;
				} else{
					pageNow++;
					var newURL = location.pathname + '?p=' + pageNow;
					history.pushState(null,'',newURL);
					self.updateByPage();
				}
			});
			$(window).on('popstate', function(event) {
				event.preventDefault();
				/* Act on the event */
				self.updateByPage();
			});
		},
		init: function() {
			this.bindEvent();
			this.navActive();
		}
	}
	index.init();
})();
</script>
<%- include base/footer.ejs %>