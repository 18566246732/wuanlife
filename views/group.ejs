<%- include base/header.ejs %>
<div class="main main-page">
	<div class="location clearfix">
		<h1>
		<a class="text-ellipsis" href="/group/<%=result.groupID%>" title="<%=result.groupName%>"><%=result.groupName%></a>
		<%if(result.identity == '01'){%>
		<a href="/group/<%=result.groupID%>/set" title="" class="gSet icon"></a>
		<% } %>
		</h1>
		<h2>
			<p class="text-ellipsis">
			创建者：<%=result.creatorName%>
			</p>
		</h2>
		<%if(result.identity == '01' || result.identity == '02'){%>
		<button type="button" id="joinBtn" class="locBtn">+发帖</button>
		<%}else if(result.identity == '04'){%>
		<button type="button" id="joinBtn" class="locBtn">+已申请</button>
		<%}else{%>
		<button type="button" id="joinBtn" class="locBtn">+加入</button>
		<%}%>
	</div>
	<%if(result.private=="1" && (result.identity=="03" || result.identity=="04")){%>
	<div class="blockPage">
		<p>您还未加入，无法浏览内容</p>
		<img src="../images/sadface.png">
	</div>
	<%} else if(result.posts.length > 0){%>
	<div class="chapter-col">
		<% result.posts.forEach(function(item) { %>
		<div class="chapter">
			<h2>
				<%if(parseInt(item.sticky)){%>
				<i class="cha-top">置顶</i>
				<%}%>
				<a href="/topic/<%=item.postID%>" title="<%-item.title%>"><%-item.title%></a></h2>
			<div class="chapter-text">
				<%-item.text%>
			</div>
			<%if(item.image.length >0){%>
			<div class="chapter-img clearfix">
				<%for(var i=0;i<item.image.length;i++){%>
				<img src="<%-item.image[i]%>?imageView2/1/w/100/h/100" alt="">
				<%}%>
			</div>
			<%}%>
			<div class="chapter-info">
				<span class="text-ellipsis"><a href="#?" title="<%=item.nickname%>"><%=item.nickname%></a></span>
				<span class="postIn">发表于</span>
				<span class="text-ellipsis"><a href="/group/<%=result.groupID%>" title="<%=result.groupName%>"><%=result.groupName%></a></span>
				<span class="cha-time"><%=item.createTime%></span>
			</div>
		</div>
		<% }); %>
	</div>
	<div class="page-turn">
		<%if(result.currentPage == 1){%>
		<button type="button" class="unCBtn" id="pre">上一页</button>
		<%}else{%>
		<button type="button" id="pre">上一页</button>
		<%}%>
		<span><%=result.currentPage%>/<%=result.pageCount%></span>
		<%if(result.currentPage == result.pageCount){%>
		<button type="button" class="unCBtn" id="next">下一页</button>
		<%}else{%>
		<button type="button" id="next">下一页</button>
		<%}%>
	</div>
	<%}else{%>
	<div class="emptyPage">
		星球空空，可以注水~~
	</div>
	<%} %>
</div>
<%- include base/baseJS.ejs %>
<script type="text/html" id="listtemplate">
	{{each posts as item i}}
	<div class="chapter">
		<h2>
			{{if item.sticky>0}}<i class="cha-top">置顶</i> {{/if}}
			<a href="/topic/{{item.postID}}" title="{{#item.title}}">{{#item.title}}</a>
		</h2>
		<div class="chapter-text">{{#item.text}}</div>
		{{if item.image.length}} {{include 'imgtemplate' item}} {{/if}}
		<div class="chapter-info">
			<span class="text-ellipsis"><a href="#?" title="{{item.nickname}}">{{item.nickname}}</a></span>
			<span class="postIn">发表于</span>
			<span class="text-ellipsis"><a href="/group/{{groupID}}" title="{{groupName}}">{{groupName}}</a></span>
			<span class="cha-time">{{item.createTime}}</span>
		</div>
	</div>
	{{/each}}
</script>
<script type="text/html" id="imgtemplate">
	<div class="chapter-img clearfix">
		{{each image as item i}}
		<img src="{{item}}?imageView2/1/w/100/h/100" alt=""> {{/each}}
	</div>
</script>
<script type="text/javascript">
	(function() {
		var group = {
			pre: $("#pre"),
			next: $("#next"),
			page: $(".page-turn").find('span').eq(0),
			main: $(".chapter-col"),
			joinBtn: $("#joinBtn"),
			loading: $(".loading"),
			identity: parseInt("<%=result.identity%>"),
			pageCount: parseInt("<%=result.pageCount%>"),
			private:parseInt("<%=result.private%>"),
			getServerData: function(param, cb) {
				global.getData("/api/getGroupPlanetShow", param, cb);
			},
			//根据SweetAlert的自定义样式方法改了下，在这个页面下封装了午安输入框。以后可以考虑放到baseJS里面
			//压缩成一行了
			//复用性有待提高，目标：实现相当于在swal外封装一层，提高复用性。
			sweetAlertForPost: function() {
				var compressedCSS = ".sweet-overlay {  background: rgba(10, 10, 10, 0.6); }.sweet-alert {  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;  padding: 24px;  padding-top: 64px;  padding-bottom: 13px;  text-align: right;  border-radius: 0;  box-shadow: 0 0 14px rgba(0, 0, 0, 0.24), 0 14px 28px rgba(0, 0, 0, 0.48); }  .sweet-alert h2 {    position: absolute;    top: 0;    left: 0;    right: 0;    height: auto;    font-weight: 400;    color: #212121;    margin: 20px 0;    font-size: 1.2em;    line-height: 1.25;    text-align: left;    padding: 0 24px; }  .sweet-alert p {    display: block;    text-align: center;    color: #212121;    font-weight: 400;    font-size: 14px;    margin: 20px 0; }  .sweet-alert button {    border-radius: 2px;    box-shadow: none !important;    background: none !important;    border-radius: 2px;    text-transform: uppercase;    font-size: 14px;    font-weight: 600;    padding: 8px 16px;    position: relative;    margin-top: 0; }    .sweet-alert button:hover, .sweet-alert button:focus {      background-color: #f6f6f6 !important; }    .sweet-alert button.confirm {      color: #3c80f6; }    .sweet-alert button.cancel {      color: #757575; }      .sweet-alert button.cancel:focus {        box-shadow: none !important; }  .sweet-alert .sa-icon:not(.sa-custom) {    transform: scale(0.8);    margin-bottom: -10px;    margin-top: -10px; }  .sweet-alert input {    border: none;    border-radius: 0;    border-bottom: 1px solid #c9c9c9;    color: #212121;    margin-bottom: 8px;    padding: 1px;    padding-bottom: 8px;    height: auto;    box-shadow: none;    font-size: 13px;    margin: 10px 0; }    .sweet-alert input:focus {      border: none;      border-bottom: 1px solid #3c80f6;      box-shadow: inset 0 -1px 0 #3c80f6; }  .sweet-alert fieldset {    padding: 0; }    .sweet-alert fieldset .sa-input-error {      display: none; }  .sweet-alert .sa-error-container {    display: none;    background: none;    height: auto;    padding: 0 24px;    margin: 0 -20px;    text-align: left; }    .sweet-alert .sa-error-container.show {      padding: 0 24px;      display: block; }      .sweet-alert .sa-error-container.show ~ fieldset input {        background: red;        border-bottom: 1px solid #d9453c;        box-shadow: inset 0 -1px 0 #d9453c; }    .sweet-alert .sa-error-container .icon {      display: none; }    .sweet-alert .sa-error-container p {      color: #d9453c;      margin-top: 0; }@-webkit-keyframes animateErrorIcon {  0% {    transform: rotateX(100deg), scale(0.5);    -webkit-transform: rotateX(100deg), scale(0.5);    opacity: 0; }  100% {    transform: rotateX(0deg), scale(0.5);    -webkit-transform: rotateX(0deg), scale(0.5);    opacity: 1; } }@keyframes animateErrorIcon {  0% {    transform: rotateX(100deg), scale(0.5);    -webkit-transform: rotateX(100deg), scale(0.5);    opacity: 0; }  100% {    transform: rotateX(0deg), scale(0.5);    -webkit-transform: rotateX(0deg), scale(0.5);    opacity: 1; } }";

				swal({
				  title: "An input!",
				  text: "<style>"+ compressedCSS +"</style>A custom <span style='color:#F8BB86'>html<span> message.",
				  type: "input",
				  html: true,
				  showCancelButton: true,
				  closeOnConfirm: false,
				  animation: "slide-from-top",
				  inputPlaceholder: "Write something"
				},
				function(inputValue){
				  if (inputValue === false) return false;
				  
				  if (inputValue === "") {
				    swal.showInputError("You need to write something!");
				    return false
				  }

				});
			},
			updateByPage:function(){
				var self = this;
				var pageNow = global.getPageNow();
				self.loading.show();
				self.getServerData({
					currentpage: pageNow,
					groupid: parseInt("<%=result.groupID%>")
				}, function(data) {
					if (pageNow != global.getPageNow()) {
						return;
					}
					if (data.ret == 200 && data.data && data.data.posts.length > 0) {
						var compiled = template("listtemplate", data.data);
						self.main.html(compiled);
						self.page.text(data.data.currentPage + '/' + data.data.pageCount);
						self.pre.removeAttr('class');
						self.next.removeAttr('class');
						if (data.data.currentPage == 1) {
							self.pre.addClass('unCBtn');
						}
						if (data.data.currentPage == data.data.pageCount) {
							self.next.addClass('unCBtn')
						}
						self.loading.hide();
						$(window).scrollTop(0);
					} else {
						self.loading.hide();
						sweetAlert('错误', '数据获取失败', 'error');
					}
				});
			},
			bindEvent: function() {
				var self = this;
				self.joinBtn.on("click", function(event) {
					event.preventDefault();
					<%if(user){%>
					switch(self.identity){
						case 1:
							window.location.href = '/group/<%=result.groupID%>/post';
							break;
						case 2:
							window.location.href = '/group/<%=result.groupID%>/post';
							break;
						case 3:
							self.joinBtn.attr('disabled',true);
							if(self.private == 0){
								global.subData('/api/applyGroup',{
									groupid: parseInt("<%=result.groupID%>")
								}, function(data) {
									if (data.ret == 200 && data.data && data.data.code == 1) {
										sweetAlert({
										title: '提示',
										text: '加入成功',
										type: 'success',
										timer: 2000
										});
										self.joinBtn.text('+发帖'); //加入成功
										self.identity = 2;
									} else {
										sweetAlert('错误', '加入星球失败', 'error');
									}
									self.joinBtn.removeAttr('disabled');
								});
							} else if(self.private == 1) {
								global.subData("/api/applyPrivateGroup",{
									groupid: parseInt("<%=result.groupID%>")
								}, function(data) {
									if (data.ret == 200 && data.data && data.data.code == 1) {
											sweetAlert({
											title: '提示',
											text: '申请成功等待审核',
											type: 'success',
											timer: 2000
											});
										self.joinBtn.text('+已申请'); //正在申请
										self.identity = 4;
									} else {
										sweetAlert('错误', '加入星球失败', 'error');
									}
									self.joinBtn.removeAttr('disabled');
								});					
							}
							break;
						case 4:
							sweetAlert('提示', '已提交申请，请等待审核', 'warning');
							break;
						default:
							console.log(self.identity);
							break;
					}
					<%}else{%>
					window.location.href = '/login';
					<%}%>
				});
				global.pageTurning.apply(self,["#pre","#next",self.pageCount,self.updateByPage]);
			},
			init: function() {
				this.bindEvent();
			}
		}
		group.init();
	})();
</script>
<%- include base/footer.ejs %>