<%- include base/header.ejs %>
<div class="content">
      <div class="section">
            <div class="section-hd">
                <span>个人资料</span>
                <!-- 以防万一在这留了一个可以在右边扩展的div-->
                <div class="slide-controls">
                </div> 
            </div>
            <div class="section-content">
                <form id="personal">
                    <div class="pensonal-img">
                        <div class="img-upload-progress"></div>
                        <button type="button" id="user-image-upload" style="background-image:url(<%=result.profile_picture%>);"></button>
                        <input type="hidden" name="g_image" value="<%=result.profile_picture%>" id="g_img">
                        <span>修改</span>
                    </div>
                    <div class="pensonal-mail">
                        <label for="email" class="input-text">邮箱</label>
                        <input type="email" id="email" value="<%=result.user_email%>" disabled>
                        <% if(result.mail_checked >0){%>
                        <button type="button" id="verifibtn">已验证</button>
                        <%}else{%>
                        <button type="button" id="verifibtn-on">验证</button>
                        <%}%>
                    </div>
                    <div class="pensonal-name">
                        <label for="name" class="input-text">昵称</label>
                        <input type="text" id="name" autocomplete="off" value="<%=result.user_name%>">
                    </div>
                    <div class="pensonal-sex">
                        <label for="male" class="label-1 input-text">性别</label>
                        <input type="radio" name="sex" value="male" id="male" autocomplete="off">
                        <span>
                            <%if(result.sex==1){%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon" data-sex="1">
                                </use>
                            </svg>男
                            <%}else{%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon_not" data-sex="1">
                                </use>
                            </svg>男
                            <%}%>
                        </span>
                        <label for="female" class="label-e"></label>
                        <input type="radio" name="sex" value="male" id="female">
                        <span>
                            <%if(result.sex==2){%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon" data-sex="2">
                                </use>
                            </svg>女
                            <%}else{%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon_not" data-sex="2">
                                </use>
                            </svg>女
                            <%}%>
                        </span>
                        <label for="unknow" class="label-e"></label>
                        <input type="radio" name="sex" value="unknow" id="unknow">
                        <span>
                            <%if(result.sex==0){%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon" data-sex="0">
                                </use>
                            </svg>不想透露
                            <%}else{%>
                            <svg aria-hidden="true" class="icon">
                                <use xlink:href="#icon-pitchon_not" data-sex="0">
                                </use>
                            </svg>不想透露
                            <%}%>
                        </span>
                    </div>
                    <div class="pensonal-birthday">
                        <label for="year" class="label-year input-text">生日</label>
                        <input type="text" name="year" placeholder="如1990" id="year" value="<%=result.year%>" autocomplete="off">
                        <label for="month" class="label-month"></label>
                        <input type="text" name="month" placeholder="如01" id="month" value="<%=result.month%>" autocomplete="off">
                        <label for="day" class="label-day"></label>
                        <input type="text" name="day" placeholder="如01" id="day" value="<%=result.day%>" autocomplete="off">
                    </div>
                    <button class="pensonal-save" type="submit">保存</button>
                </form>
            </div>  
      </div>

      <div class="changepsw-content">

      </div>
</div>

<%- include base/baseJS.ejs %>
<script type="text/javascript">
  (function(){
    var users={
          loading:HJLoading,
          personalForm:$("#personal"),
          verifibtn:$("#verifibtn"),
          year: null,
          month: null,
          day: null,
          sex: '0',
          user_name:null,
          oldname:null,
          bindTagEvent:function(){
            $(".pensonal-sex").children("span").click(function(e){
              console.log("god");
              e.preventDefault();
              $(this).find("use").attr("xlink:href","#icon-pitchon");
              $(this).siblings("span").find("use").attr("xlink:href","#icon-pitchon_not");
            });
          },
          ClientData: function() {
            this.year = "<%=result.year%>";
            this.month = "<%=result.month%>";
            this.day = "<%=result.day%>";
            this.sex = "<%=result.sex%>";
            this.user_name="<%=result.user_name%>";
            this.oldname="<%=result.user_name%>";
          },
          //验证填入表单的字符
          verificate:function(){
            //正则匹配数字字母汉字下划线
            var myregName = /^[0-9a-zA-Z\u4E00-\u9FA5\_]*$/;
            var name=$("#name").val();
            if(name.length==0||name.length>18){
              sweetAlert('格式错误', '请输入1-18位字符作为昵称！', 'warning');
              return false;
            }
            if (!myregName.test(name)) {
              sweetAlert('格式错误', '只允许中文、数字、字母和下划线！', 'warning');
              return false;
            }
            this.user_name = name;
            //验证性别
            var usersex;
            $(".pensonal-sex").children("span").each(function(){
              var sexstus=$(this).find("use").attr("xlink:href");
              if(sexstus=="#icon-pitchon"){
                usersex=$(this).find("use").attr("data-sex");
              }
            });
            this.sex=usersex;
            //验证日期
            if(!($("#year").val()) && !($("#month").val()) && !($("#day").val())){
              this.year=this.month=this.day=null;
              return true;
            }
            var d=new Date();
            var myregMonth=/^0[1-9]|1[12]$/;
            var month=$("#month").val();
            if(!myregMonth.test(month)||month.length!=2){
              sweetAlert('格式错误', '请填写正确格式的月份！', 'warning');
              return false;
            }
            this.month=month;
            var myregDay=/^0[1-9]|[12][0-9]|3[01]$/;
            var day=$("#day").val();
            if(!myregDay.test(day)||day.length!=2){
              sweetAlert('格式错误', '请填写正确格式的日期！', 'warning');
              return false;
            }
            this.day=day;
            var myregYear=/^[0-9]{4}$/;
            var year=$("#year").val();
            if(!myregYear.test(year)){
              sweetAlert('格式错误', '请填写正确格式的年份！', 'warning');
              return false;
            }
            if(year<1900||year>d.getFullYear()){
              sweetAlert('格式错误', '请填写正确的年份！', 'warning');
              return false;
            }
            this.year=year;
            return true;
          },
          bindEvent:function(){
            var self=this;
            self.personalForm.submit(function(event){
              event.preventDefault();
              if(self.verificate()){
                //self.loading.show();
                self.loading.start({
                    loadingTPLId : 0,
                    target : $(".content"),
                    loadingId : 'self'
                  });
                var subdata={
                  user_name:self.user_name,
                  profile_picture:$("#g_img").val(),
                  sex:self.sex,
                  year:self.year,
                  month:self.month,
                  day:self.day
                  };
                global.getData('/users/sub/',
                  {
                    user_name:self.user_name,
                    profile_picture:$("#g_img").val(),
                    sex:self.sex,
                    year:self.year,
                    month:self.month,
                    day:self.day
                  },function(data){
                  //self.loading.hide();
                  self.loading.stop('self');
                  if(data.ret==200){
                    if(data.data==1){
                      sweetAlert('成功',data.msg,'success');
                    }else{
                      sweetAlert('提示', data.msg, 'warning');
                    }
                  }else{
                    sweetAlert('错误', data.msg, 'error');
                  }
                });


              }
            });
          },
          init:function(){
            console.log("hehe");
            this.bindEvent();
            this.bindTagEvent();
            this.ClientData();
            //this.verifimail();
            //wuanHeadFun.title("个人资料");
      }
    };
    users.uploader = Qiniu.uploader({
      runtimes: 'html5,flash,html4', //上传模式,依次退化
      browse_button: 'user-image-upload', //上传选择的点选按钮，**必需**
      uptoken_url: '/uptoken',
      //Ajax请求upToken的Url，**强烈建议设置**（服务端提供）
      // uptoken : '<Your upload token>',
      //若未指定uptoken_url,则必须指定 uptoken ,uptoken由其他程序生成
      unique_names: true,
      // 默认 false，key为文件名。若开启该选项，SDK会为每个文件自动生成key（文件名）
      // save_key: true,
      // 默认 false。若在服务端生成uptoken的上传策略中指定了 `sava_key`，则开启，SDK在前端将不对key进行任何处理
      domain: 'http://7xlx4u.com1.z0.glb.clouddn.com/',
      //bucket 域名，下载资源时用到，**必需**
      //container: containerId,           //上传区域DOM ID，默认是browser_button的父元素，
      max_file_size: '100mb', //最大文件体积限制
      flash_swf_url: '/javascripts/plupload/Moxie.swf', //引入flash,相对路径
      filters: {
        mime_types: [
          //只允许上传图片文件 （注意，extensions中，逗号后面不要加空格）
          {
            title: "图片文件",
            extensions: "jpg,gif,png,bmp"
          }
        ]
      },
      max_retries: 3, //上传失败最大重试次数
      dragdrop: true, //开启可拖曳上传
      //drop_element: 'editor-container',        //拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
      chunk_size: '4mb', //分块上传时，每片的体积
      auto_start: true, //选择文件后自动上传，若关闭需要自己绑定事件触发上传
      init: {
        'FilesAdded': function(up, files) {
          plupload.each(files, function(file) {
            // 文件添加进队列后,处理相关的事情
            //printLog('on FilesAdded');
          });
        },
        'BeforeUpload': function(up, file) {
          // 每个文件上传前,处理相关的事情
          //printLog('on BeforeUpload');
        },
        'UploadProgress': function(up, file) {
          // 显示进度条
          showUploadProgress(file.percent);
        },
        'FileUploaded': function(up, file, info) {
          // 每个文件上传成功后,处理相关的事情
          // 其中 info 是文件上传成功后，服务端返回的json，形式如
          // {
          //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
          //    "key": "gogopher.jpg"
          //  }
          //printLog(info);
          // 参考http://developer.qiniu.com/docs/v6/api/overview/up/response/simple-response.html

          var domain = up.getOption('domain');
          var res = $.parseJSON(info);
          var sourceLink = domain + res.key; //获取上传成功后的文件的Url

          // printLog(sourceLink);
          //console.log(sourceLink);
          var url = sourceLink + '?imageView2/1/w/100/h/100';
          //设置表单图片数据
          $("#g_img").val(url);
          var src = 'url(' + url + ')';
          // 设置图片为背景
          $("#user-image-upload").html("");
          $("#user-image-upload").css('background-image', src);
        },
        'Error': function(up, err, errTip) {
          //上传出错时,处理相关的事情
          sweetAlert('错误', errTip, 'error');
        },
        'UploadComplete': function() {
            //队列文件处理完毕后,处理相关的事情
            //printLog('on UploadComplete');

            // 隐藏进度条
            hideUploadProgress();
          }
          // Key 函数如果有需要自行配置，无特殊需要请注释
          //,
          // 'Key': function(up, file) {
          //     // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
          //     // 该配置必须要在 unique_names: false , save_key: false 时才生效
          //     var key = "";
          //     // do something with key here
          //     return key
          // }
      }
    });
    function showUploadProgress(progress) {
      var $progress = $(".img-upload-progress");
      var width = $(".personal-image").width();
      $progress.css('visibility', 'visible');
      $progress.width(progress * width / 100);
    }

    function hideUploadProgress() {
      var $progress = $(".img-upload-progress");
      $progress.css('visibility', 'hidden');
    }
    users.init();
      })()
</script>
<%- include base/footerMobile.ejs %>