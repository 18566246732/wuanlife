<%- include base/header.ejs %>
<div class="main main-page">
    <!--   之后记住照着uGroup改一下这里 -->
    <div class="location clearfix">
        <h1><a href="/message" title="">消息中心</a></h1>
    </div>
    <%if(result.code == 1){%>
    <div class="message-col">
       
        <% result.info.forEach(function(item) { %>
        <div class="message clearfix" data-identity="{'user_id':<%=user%>, 'group_id':<%=user%> }">
            <h2>
                <p class="text-ellipsis"><%=item.information%></p>
            </h2>
            <%if(item.messagetype == '01') { %>
            <button class="meg-button agree" type="button">同意</button>
            <button class="meg-button disagree" type="button">拒绝</button>
            <% } else if(item.messagetype == '02') { %>


            <% } %>
        </div>

        <% }); %>
    </div>
    <div class="page-turn">
        <%if(result.currentPage == 1){%>
        <button type="button" class="unCBtn" id="pre">上一页</button>
        <%}else{%>
        <button type="button" id="pre">上一页</button>
        <%}%>
        <span><%=result.currentPage%>/<%=result.pageCount%></span>
        <%if(result.currentPage == result.pageCount){%>
        <button type="button" class="unCBtn" id="next">下一页</button>
        <%}else{%>
        <button type="button" id="next">下一页</button>
        <%}%>
    </div>
    <%}else{%>
    <div class="emptyPage">
        您还没有消息哦
    </div>
    <%} %>
</div>
<%- include base/baseJS.ejs %>

<script type="text/javascript">
    (function() {
        var group = {
            pre: $("#pre"),
            next: $("#next"),
            page: $(".page-turn").find('span').eq(0),
            main: $(".message-col"),
            joinBtn: $("#joinBtn"),
            loading: $(".loading"),
            isjoin: 0,
            pageCount: parseInt("<%=result.pageCount%>"),
            getServerData: function(param, cb) {
                global.getData("/api/getGroupPlanetShow", param, cb);
            },
            getJoinPData: function(param, cb) {
                global.getData("/api/joinPlant", param, cb);
            },
            postApplyPrivate: function(param, cb) {
                global.getData("api/applyPrivateGroup")
            },
            getJoinBtnVal: function(param, cb) {
                global.getData("/api/isJoinP", param, cb);
            },
            <%if(user){%>
            setJoinBtnVal: function() {
                var self = this;
                self.getJoinBtnVal({
                    groupid: parseInt("<%=result.groupID%>")
                }, function(data) {
                    if (data.ret == 200 && data.data) {
                        if (data.data.code == 1) {
                            self.joinBtn.text('+发帖');
                            self.isjoin = 1; //已加入
                        }
                    }
                });
            },
            <%}%>
            updateByPage:function(){
                var self = this;
                var pageNow = global.getPageNow();
                self.loading.show();
                self.getServerData({
                    currentpage: pageNow,
                    groupid: parseInt("<%=result.groupID%>")
                }, function(data) {
                    if (pageNow != global.getPageNow()) {
                        return;
                    }
                    if (data.ret == 200 && data.data && data.data.posts.length > 0) {
                        var compiled = template("listtemplate", data.data);
                        self.main.html(compiled);
                        self.page.text(data.data.currentPage + '/' + data.data.pageCount);
                        self.pre.removeAttr('class');
                        self.next.removeAttr('class');
                        if (data.data.currentPage == 1) {
                            self.pre.addClass('unCBtn');
                        }
                        if (data.data.currentPage == data.data.pageCount) {
                            self.next.addClass('unCBtn')
                        }
                        self.loading.hide();
                        $(window).scrollTop(0);
                    } else {
                        self.loading.hide();
                        sweetAlert('错误', '数据获取失败', 'error');
                    }
                });
            },
            bindEvent: function() {
                var self = this;
                self.joinBtn.on("click", function(event) {
                    event.preventDefault();
                    <%if(user){%>
                    if (self.isjoin == 1) {
                        window.location.href = '/group/<%=result.groupID%>/post';
                    } else if(result.private=="0"){
                        self.getJoinPData({
                            groupid: parseInt("<%=result.groupID%>")
                        }, function(data) {
                            if (data.ret == 200 && data.data && data.data.code == 1) {
                                    sweetAlert({
                                    title: '提示',
                                    text: '加入成功',
                                    type: 'success',
                                    timer: 2000
                                });
                                self.joinBtn.text('+发帖'); //加入成功
                                self.isjoin = 1;
                            } else {
                                sweetAlert('错误', '加入星球失败', 'error');
                            }
                        });
                    } else if(result.private=="1") {
                        self.postApplyPrivate({
                            groupid: parseInt("<%=result.groupID%>")
                        }, function(data) {
                            if (data.ret == 200 && data.data && data.data.code == 1) {
                                    sweetAlert({
                                    title: '提示',
                                    text: '申请成功等待审核',
                                    type: 'success',
                                    timer: 2000
                                });
                                self.joinBtn.text('已申请'); //加入成功
                                self.isjoin = 0;
                            } else {
                                sweetAlert('错误', '加入星球失败', 'error');
                            }
                        });                 
                    }
                    <%}else{%>
                    window.location.href = '/login';
                    <%}%>
                });
                global.pageTurning.apply(self,[self.pre,self.next,self.pageCount,self.updateByPage]);
            },
            init: function() {
                <%if(user){%>
                this.setJoinBtnVal();
                <%}%>
                this.bindEvent();
            }
        }
        group.init();
    })();
</script>
<%- include base/footer.ejs %>