<%- include base/header.ejs %>
        <div class="main">
            <div class="location clearfix">
                <h1>编辑帖子</h1>
            </div> 
            <div class="post">
                <form class="post-form clearfix" action="/postEdit/<%=result%>" method="post">
                    <input type="text" name="" value="" class="form-control" id="post-title">
                    <div class="wangEditor-pc-container">
                        <textarea name="" class="form-control" id="textareaPC">
                            
                        </textarea>
                        <div class="getContent" style="display:none;"></div>
                    </div>
                    <button type="submit" class="post-sub" id="post-issue">发表</button>
                </form>  
            </div>
        </div>
<%- include base/baseJS.ejs %>
		<script>
            var editor;
			var postEdit = {
                PCtext: $("#textareaPC"),
                postTitle:$("#post-title"),
				title: $("#post-title"),
				postForm: $(".post-form"),
                getContent:$(".getContent"),
                p_image:[],
                setImage:function(imgs,imageData){ 
                    var self = this;
                    self.p_image = imageData;
                    var imgNum = imgs.length;
                    for(var i=0;i<imgNum;i++){
                        var img = imgs.eq(i);
                        var src = self.p_image[i].URL;
                        var imgId = self.p_image[i].id;
                        img.attr({
                            src: src,
                            id: imgId
                        });
                    }
                },
				verificate: function() {
					if (this.title.val().length == 0) {
						sweetAlert('格式错误', '请填写标题！', 'warning');
						return false;
					}
                    if (this.title.val().length > 20) {
                        sweetAlert('格式错误', '请设置20字符以内标题', 'warning');
                        return false;
                    }
                    var imgs = editor.$txt.find('img').length;
                    var iframes = editor.$txt.find('iframe').length;
                    if (editor.$txt.formatText().replace(/&nbsp;|\s/g,"").length == 0&& imgs == 0 && iframes == 0) {
                        sweetAlert('格式错误', '请填写内容！', 'warning');
                        return false;
                    }
					return true;
				},
                editorEvent:function(){
                    $(".wangEditor-container").find('*').focus(function(event) {
                        /* Act on the event */
                        $(".wangEditor-container").addClass('textarea-focus');
                        // console.log(event.target);
                    });
                    $(".wangEditor-container").find('*').blur(function(event) {
                        /* Act on the event */
                        $(".wangEditor-container").removeClass('textarea-focus');
                    });
                },
                getPostForEdit:function(param, cb){
                    var self = this;
                    $.ajax({
                            type: "get",
                            url: "/api/getPostForEdit",
                            async: true,
                            data: {
                                postid:<%=result%>,
                                userid:localStorage.getItem("userID")    
                            },
                            success: function(data) {
                                console && console.log(data);
                              if (data.ret == 200 && data.data && data.data.editRight == 1){
                                    self.getContent.html(data.data.text);
                                    var imgs = self.getContent.find('img:not([src^="http://img.t.sinajs.cn"])');
                                    self.setImage(imgs, data.data.p_image);
                                    self.PCtext.html(self.getContent.html());
                                    self.getContent.remove();
                                    //禁止输出log调试
                                    wangEditor.config.printLog = false;
                                    editor = new wangEditor("textareaPC");
                                    editor.config.menus = [
                                    'fontfamily',
                                    'fontsize',
                                    'bold',
                                    'underline',
                                    'italic',
                                    'strikethrough',
                                    'eraser',
                                    'forecolor',
                                    'bgcolor',
                                    '|',
                                    'orderlist',
                                    'alignleft',
                                    'aligncenter',
                                    'alignright',
                                    '|',
                                    'img',
                                    'link',
                                    'emotion',
                                    'undo',
                                    'redo',
                                    ];
                                    editor.config.uploadImgUrl = '/postEdit/<%=result%>';
                                    editor.create();
                                    self.editorEvent();
                                    self.postTitle.val(data.data.title);
                                }
                            },
                            error: function(x, h, r) {
                                console && console.log(x, h, r);
                            }
                    });
                },
                getDeleteImg:function(){
                    var self = this;
                    var imgs = editor.$txt.find('img[src^="http://dev.wuanlife.com:800"]');
                    //console.log(imgs[0]);
                    var retainImg = [];
                    var deleteImg = [];
                    for(var i=0;i<imgs.length;i++){
                        retainImg.push(parseInt(imgs.eq(i).attr('id')));
                    }
                    for(var j=0;j<self.p_image.length;j++){
                        var originId = parseInt(self.p_image[j].id);
                        if ($.inArray(originId, retainImg)<0) {
                            deleteImg.push(originId);
                        }
                    }
                    console.log(deleteImg);
                },
				bindEvent: function() {
					var self = this;
					self.postForm.submit(function() {
                        self.getDeleteImg();
						event.preventDefault();
						if (self.verificate()) {
							$.ajax({
								type: "post",
								url: "/postEdit/<%=result%>",
								async: true,
								data: {
									user_id: localStorage.getItem("userID"),
									title: self.title.val(),
									text: editor.$txt.html().trim()
								},
								success: function(data) {
									console && console.log(data);
                                    if (data.ret == 200 && data.data){
                                        if (data.data.code == 0 && data.data.msg) {
                                            sweetAlert('提示', data.data.msg, 'warning');
                                        } else {
                                            window.location.href = '/topic/' + data.data.info.post_base_id;
                                        }
                                    }
								},
								error: function(x, h, r) {
									console && console.log(x, h, r);
								}
							});
						}
					});
				},
				init: function() {
                    global.GotoIndex();
                    this.getPostForEdit();
					this.bindEvent();
				}
			}
			postEdit.init();
		</script>
<%- include base/footer.ejs %>